<!DOCTYPE html>
<html>
<head>
    <title>Ð’Ð¸Ð´ÐµÐ¾Ð—Ð²Ð¾Ð½Ð¾Ðº</title>
    <style>
        #videos { display: flex; gap: 20px; }
        video { width: 45%; height: auto; background: black; }
    </style>
</head>
<body>
    <div id="videos">
        <video id="localVideo" autoplay muted></video>
        <video id="remoteVideo" autoplay></video>
    </div>

    <script>
        const roomName = "testroom";
        const ws = new WebSocket(`ws://${window.location.host}/ws/videocall/${roomName}/`);

        const configuration = {
            iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
        };
        const peerConnection = new RTCPeerConnection(configuration);
        console.log(peerConnection)

        const localVideo = document.getElementById("localVideo");
        const remoteVideo = document.getElementById("remoteVideo");

        let pendingCandidates = [];

        peerConnection.ontrack = event => {
            if (remoteVideo.srcObject !== event.streams[0]) {
                remoteVideo.srcObject = event.streams[0];
                console.log("ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½ ÑƒÐ´Ð°Ð»Ñ‘Ð½Ð½Ñ‹Ð¹ Ð²Ð¸Ð´ÐµÐ¾Ð¿Ð¾Ñ‚Ð¾Ðº.");
            }
        };

        peerConnection.onicecandidate = event => {
            if (event.candidate) {
                ws.send(JSON.stringify({ type: 'ice', candidate: event.candidate }));
            }
        };

        peerConnection.oniceconnectionstatechange = () => {
            console.log("ICE ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ:", peerConnection.iceConnectionState);
        };

        peerConnection.onconnectionstatechange = () => {
            console.log("Connection ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ:", peerConnection.connectionState);
        };

        // Ð’Ñ‹Ð±Ð¸Ñ€Ð°ÐµÐ¼ ÐºÐ°Ð¼ÐµÑ€Ñƒ, Ð¾Ñ‚Ð»Ð¸Ñ‡Ð½ÑƒÑŽ Ð¾Ñ‚ DroidCam
        navigator.mediaDevices.enumerateDevices()
        .then(devices => {
            const videoDevice = devices.find(d => d.kind === 'videoinput' && !d.label.toLowerCase().includes('droidcam'));
            if (!videoDevice) throw new Error("ÐÐµÑ‚ Ð¿Ð¾Ð´Ñ…Ð¾Ð´ÑÑ‰ÐµÐ¹ ÐºÐ°Ð¼ÐµÑ€Ñ‹");

            return navigator.mediaDevices.getUserMedia({
                video: { deviceId: videoDevice.deviceId },
                audio: true
            });
        })
        .then(stream => {
            localVideo.srcObject = stream;
            stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));

            // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ offer Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ð¾ÑÐ»Ðµ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ñ‚Ñ€ÐµÐºÐ¾Ð²
            if (isInitiator) {
                console.log("ðŸŽ¬ Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ offer Ð¿Ð¾ÑÐ»Ðµ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ñ‚Ñ€ÐµÐºÐ¾Ð²");
                peerConnection.createOffer()
                    .then(offer => {
                        return peerConnection.setLocalDescription(offer).then(() => {
                            ws.send(JSON.stringify({ type: 'offer', offer }));
                        });
                    });
            }
        });

        let isInitiator = false;

        ws.onmessage = async (event) => {
            const data = JSON.parse(event.data);
            console.log("WS message received:", data);

            if (data.type === 'role') {
                console.log("Your role:", data.initiator ? "initiator" : "receiver");
            }
            if (data.type === 'offer') console.log("Received offer");
            if (data.type === 'answer') console.log("Received answer");
            if (data.type === 'ice') console.log("Received ICE candidate");

            if (data.type === 'role') {
                isInitiator = data.initiator;
                if (isInitiator) {
                    console.log("Ð¡Ð¾Ð·Ð´Ð°ÑŽ offer. Ð¢Ñ€ÐµÐºÐ¸:", peerConnection.getSenders());
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    ws.send(JSON.stringify({ type: 'offer', offer }));
                }
            } else if (data.type === 'offer') {
                if (isInitiator) {
                    console.log("ðŸ‘€ ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐ²Ð¾Ð¹ Ð¶Ðµ offer");
                    return;
                }
                console.log("ðŸ“© ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½ offer", data.offer);
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                console.log("âœ… setRemoteDescription DONE");

                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                console.log("âœ… createAnswer & setLocalDescription DONE");

                ws.send(JSON.stringify({ type: 'answer', answer }));
                console.log("ðŸ“¤ ÐžÑ‚Ð²ÐµÑ‚ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½:", answer);

                pendingCandidates.forEach(c => peerConnection.addIceCandidate(c));
                pendingCandidates = [];

            } else if (data.type === 'answer') {
                if (!isInitiator) {
                    console.log("ðŸ‘€ ÐŸÑ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐ²Ð¾Ð¹ Ð¶Ðµ answer");
                    return;
                }
                console.log("ðŸ“© ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½ answer", data.answer);
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                console.log("âœ… setRemoteDescription (answer) DONE");

                pendingCandidates.forEach(c => peerConnection.addIceCandidate(c));
                pendingCandidates = [];

            } else if (data.type === 'ice') {
                if (peerConnection.remoteDescription) {
                    await peerConnection.addIceCandidate(data.candidate);
                } else {
                    pendingCandidates.push(data.candidate);
                }
            }
        };
    </script>
</body>
</html>
