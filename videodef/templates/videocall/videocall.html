<!DOCTYPE html>
<html>
<head>
    <title>–í–∏–¥–µ–æ–ó–≤–æ–Ω–æ–∫</title>
    <style>
        #videos { display: flex; justify-content: space-around; }
        video { width: 35%; height: auto; background: black; }
        #controls { display: flex; }
        .video-call-page header,
        .video-call-page nav,
        .video-call-page .page_name {
            display: none;
        }
    </style>
</head>
<body class="video-call-page">
    <div id="videos" data-room-name="{{ room_name }}">
        <video id="localVideo" autoplay muted></video>
        <video id="remoteVideo" autoplay></video>
    </div>

    <div id="controls">
        <button onclick="toggleMic()">üéôÔ∏è –ú–∏–∫—Ä–æ—Ñ–æ–Ω</button>
        <button onclick="toggleCam()">üì∑ –ö–∞–º–µ—Ä–∞</button>
        <button onclick="endCall()">‚ùå –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
    </div>

    <div>
        {% include 'game/whiteboard.html' %}
    </div>

    <script>
        const roomName = document.getElementById('videos').dataset.roomName;
        let ws = new WebSocket(`ws://${window.location.host}/ws/videocall/${roomName}/`);

        const configuration = {
            iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
        };
        let peerConnection = new RTCPeerConnection(configuration);
        console.log(peerConnection)

        const localVideo = document.getElementById("localVideo");
        const remoteVideo = document.getElementById("remoteVideo");

        let pendingCandidates = [];


        function setPeerConnectionOntrack() {
            peerConnection.ontrack = event => {
                console.log("Received track: ", event);
                if (event.streams.length > 0) {
                    const remoteStream = event.streams[0];
                    if (remoteVideo.srcObject !== remoteStream) {
                        remoteVideo.srcObject = remoteStream;
                        console.log("–û–±–Ω–æ–≤–ª–µ–Ω —É–¥–∞–ª—ë–Ω–Ω—ã–π –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫.");
                    }
                }
            };
        }
        
        setPeerConnectionOntrack();

        function setPeerConnectionOnicecandidate() {
            console.log(222)
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    ws.send(JSON.stringify({ type: 'ice', candidate: event.candidate }));
                }
            };
        }
        setPeerConnectionOnicecandidate();

        

        peerConnection.oniceconnectionstatechange = () => {
            console.log("ICE —Å–æ—Å—Ç–æ—è–Ω–∏–µ:", peerConnection.iceConnectionState);
            if (peerConnection.iceConnectionState === 'failed') {
                console.log("0000 –û—á–∏—â–∞–µ–º –≤—Å–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ")
                peerConnection.close();
                peerConnection = new RTCPeerConnection(configuration);
                setPeerConnectionOntrack();  // –ø–æ–≤—Ç–æ—Ä–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                setPeerConnectionOnicecandidate();
            }
        };

        peerConnection.onconnectionstatechange = () => {
            console.log("Connection —Å–æ—Å—Ç–æ—è–Ω–∏–µ:", peerConnection.connectionState);
        };

        console.log("Initiator Peer Connection State: ", peerConnection.connectionState);
        console.log("Remote Description: ", peerConnection.remoteDescription);

        // –í—ã–±–∏—Ä–∞–µ–º –∫–∞–º–µ—Ä—É, –æ—Ç–ª–∏—á–Ω—É—é –æ—Ç DroidCam
        navigator.mediaDevices.enumerateDevices()
        .then(devices => {
            const videoDevice = devices.find(d => d.kind === 'videoinput' && !d.label.toLowerCase().includes('droidcam'));
            if (!videoDevice) throw new Error("–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–µ–π –∫–∞–º–µ—Ä—ã");

            return navigator.mediaDevices.getUserMedia({
                video: { deviceId: videoDevice.deviceId },
                audio: true
            });
        })
        .then(stream => {
            localVideo.srcObject = stream;
            stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));

            // –°–æ–∑–¥–∞–µ–º offer —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–µ–∫–æ–≤
            if (isInitiator) {
                console.log("üé¨ –°–æ–∑–¥–∞—ë–º offer –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–µ–∫–æ–≤");
                peerConnection.createOffer()
                    .then(offer => {
                        return peerConnection.setLocalDescription(offer).then(() => {
                            ws.send(JSON.stringify({ type: 'offer', offer }));
                        });
                    });
            }
        });

        let isInitiator = false;

        ws.onmessage = async (event) => {
            const data = JSON.parse(event.data);
            console.log("WS message received:", data);

            if (data.type === 'ready' && isInitiator) {
                console.log("üé¨ –û–±–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –Ω–∞ –º–µ—Å—Ç–µ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º offer");
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                ws.send(JSON.stringify({ type: 'offer', offer }));
            }

            if (data.type === 'resend_offer' && isInitiator) {
                console.log("‚ôªÔ∏è –ü–µ—Ä–µ—Å–æ–∑–¥–∞—ë–º offer –ø–æ –∑–∞–ø—Ä–æ—Å—É");
                console.log("WebSocket –∑–∞–∫—Ä—ã—Ç, –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É...");
                location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                ws.send(JSON.stringify({ type: 'offer', offer }));
            }

            if (data.type === 'role') {
                console.log("Your role:", data.initiator ? "initiator" : "receiver");
            }
            if (data.type === 'offer') console.log("Received offer");
            if (data.type === 'answer') console.log("Received answer");
            if (data.type === 'ice') console.log("Received ICE candidate");

            if (data.type === 'role') {
                isInitiator = data.initiator;
            } else if (data.type === 'offer') {
                if (isInitiator) {
                    console.log("üëÄ –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–≤–æ–π –∂–µ offer");
                    return;
                }
                console.log("üì© –ü–æ–ª—É—á–µ–Ω offer", data.offer);
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                console.log("‚úÖ setRemoteDescription DONE");

                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                console.log("‚úÖ createAnswer & setLocalDescription DONE");

                ws.send(JSON.stringify({ type: 'answer', answer }));
                console.log("üì§ –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω:", answer);

                pendingCandidates.forEach(c => peerConnection.addIceCandidate(c));
                pendingCandidates = [];

            } else if (data.type === 'answer') {
                if (!isInitiator) {
                    console.log("üëÄ –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–≤–æ–π –∂–µ answer");
                    return;
                }
                console.log("üì© –ü–æ–ª—É—á–µ–Ω answer", data.answer);
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                console.log("‚úÖ setRemoteDescription (answer) DONE");

                pendingCandidates.forEach(c => peerConnection.addIceCandidate(c));
                pendingCandidates = [];

            } else if (data.type === 'ice') {
                if (peerConnection.remoteDescription) {
                    await peerConnection.addIceCandidate(data.candidate);
                } else {
                    pendingCandidates.push(data.candidate);
                }
            }
        };
    </script>

    <script>
        function toggleMic() {
            let localStream = document.getElementById("localVideo").srcObject;
            localStream.getAudioTracks().forEach(track => track.enabled = !track.enabled);
        }

        function toggleCam() {
            let localStream = document.getElementById("localVideo").srcObject;
            localStream.getVideoTracks().forEach(track => track.enabled = !track.enabled);
        }

        function endCall() {
            ws.close();
            peerConnection.close();
            window.location.href = "/chats/";
        }
    </script>
</body>
</html>
