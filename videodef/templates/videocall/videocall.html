<!DOCTYPE html>
<html>
<head>
    <title>–í–∏–¥–µ–æ–ó–≤–æ–Ω–æ–∫</title>
    <style>
        #videos { display: flex; gap: 20px; }
        video { width: 45%; height: auto; background: black; }
    </style>
</head>
<body>
    <div id="videos" data-room-name="{{ room_name }}">
        <video id="localVideo" autoplay muted></video>
        <video id="remoteVideo" autoplay></video>
    </div>

    <div id="controls">
        <button onclick="toggleMic()">üéôÔ∏è –ú–∏–∫—Ä–æ—Ñ–æ–Ω</button>
        <button onclick="toggleCam()">üì∑ –ö–∞–º–µ—Ä–∞</button>
        <button onclick="endCall()">‚ùå –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
    </div>

    <div>
        {% include 'game/whiteboard.html' %}
    </div>

    <script>
        const roomName = document.getElementById('videos').dataset.roomName;
        const ws = new WebSocket(`ws://${window.location.host}/ws/videocall/${roomName}/`);

        const configuration = {
            iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
        };
        const peerConnection = new RTCPeerConnection(configuration);
        console.log(peerConnection)

        const localVideo = document.getElementById("localVideo");
        const remoteVideo = document.getElementById("remoteVideo");

        let pendingCandidates = [];

        peerConnection.ontrack = event => {
            if (remoteVideo.srcObject !== event.streams[0]) {
                remoteVideo.srcObject = event.streams[0];
                console.log("–ü–æ–ª—É—á–µ–Ω —É–¥–∞–ª—ë–Ω–Ω—ã–π –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫.");
            }
        };

        peerConnection.onicecandidate = event => {
            if (event.candidate) {
                ws.send(JSON.stringify({ type: 'ice', candidate: event.candidate }));
            }
        };

        peerConnection.oniceconnectionstatechange = () => {
            console.log("ICE —Å–æ—Å—Ç–æ—è–Ω–∏–µ:", peerConnection.iceConnectionState);
        };

        peerConnection.onconnectionstatechange = () => {
            console.log("Connection —Å–æ—Å—Ç–æ—è–Ω–∏–µ:", peerConnection.connectionState);
        };

        // –í—ã–±–∏—Ä–∞–µ–º –∫–∞–º–µ—Ä—É, –æ—Ç–ª–∏—á–Ω—É—é –æ—Ç DroidCam
        navigator.mediaDevices.enumerateDevices()
        .then(devices => {
            const videoDevice = devices.find(d => d.kind === 'videoinput' && !d.label.toLowerCase().includes('droidcam'));
            if (!videoDevice) throw new Error("–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–µ–π –∫–∞–º–µ—Ä—ã");

            return navigator.mediaDevices.getUserMedia({
                video: { deviceId: videoDevice.deviceId },
                audio: true
            });
        })
        .then(stream => {
            localVideo.srcObject = stream;
            stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));

            // –°–æ–∑–¥–∞–µ–º offer —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–µ–∫–æ–≤
            if (isInitiator) {
                console.log("üé¨ –°–æ–∑–¥–∞—ë–º offer –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–µ–∫–æ–≤");
                peerConnection.createOffer()
                    .then(offer => {
                        return peerConnection.setLocalDescription(offer).then(() => {
                            ws.send(JSON.stringify({ type: 'offer', offer }));
                        });
                    });
            }
        });

        let isInitiator = false;

        ws.onmessage = async (event) => {
            const data = JSON.parse(event.data);
            console.log("WS message received:", data);

            if (data.type === 'role') {
                console.log("Your role:", data.initiator ? "initiator" : "receiver");
            }
            if (data.type === 'offer') console.log("Received offer");
            if (data.type === 'answer') console.log("Received answer");
            if (data.type === 'ice') console.log("Received ICE candidate");

            if (data.type === 'role') {
                isInitiator = data.initiator;
                if (isInitiator) {
                    console.log("–°–æ–∑–¥–∞—é offer. –¢—Ä–µ–∫–∏:", peerConnection.getSenders());
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    ws.send(JSON.stringify({ type: 'offer', offer }));
                }
            } else if (data.type === 'offer') {
                if (isInitiator) {
                    console.log("üëÄ –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–≤–æ–π –∂–µ offer");
                    return;
                }
                console.log("üì© –ü–æ–ª—É—á–µ–Ω offer", data.offer);
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
                console.log("‚úÖ setRemoteDescription DONE");

                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                console.log("‚úÖ createAnswer & setLocalDescription DONE");

                ws.send(JSON.stringify({ type: 'answer', answer }));
                console.log("üì§ –û—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω:", answer);

                pendingCandidates.forEach(c => peerConnection.addIceCandidate(c));
                pendingCandidates = [];

            } else if (data.type === 'answer') {
                if (!isInitiator) {
                    console.log("üëÄ –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–≤–æ–π –∂–µ answer");
                    return;
                }
                console.log("üì© –ü–æ–ª—É—á–µ–Ω answer", data.answer);
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
                console.log("‚úÖ setRemoteDescription (answer) DONE");

                pendingCandidates.forEach(c => peerConnection.addIceCandidate(c));
                pendingCandidates = [];

            } else if (data.type === 'ice') {
                if (peerConnection.remoteDescription) {
                    await peerConnection.addIceCandidate(data.candidate);
                } else {
                    pendingCandidates.push(data.candidate);
                }
            }
        };
    </script>

    <script>
        let localStream;

        function toggleMic() {
            localStream.getAudioTracks().forEach(track => track.enabled = !track.enabled);
        }

        function toggleCam() {
            localStream.getVideoTracks().forEach(track => track.enabled = !track.enabled);
        }

        function endCall() {
            ws.close();
            peerConnection.close();
            window.location.href = "/chats/";
        }
    </script>
</body>
</html>
